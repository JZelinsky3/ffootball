<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JZ Fantasy Football - Player Tiers</title>

  <!-- CSS -->
  <link rel="stylesheet" href="tiers.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUk7lfFezJ-pL_-MaDSIoL5RzogPnJw4c",
      authDomain: "ffootball-1ffa4.firebaseapp.com",
      projectId: "ffootball-1ffa4",
      storageBucket: "ffootball-1ffa4.appspot.com",
      messagingSenderId: "214820317243",
      appId: "1:214820317243:web:00907255d3ee230f21541e",
      measurementId: "G-H9LQY4GWSN"
    };

    if (!window.firebaseApp) {
      window.firebaseApp = initializeApp(firebaseConfig);
      window.db = getFirestore(window.firebaseApp);
    }
  </script>
</head>
<body>
  <!-- HEADER / NAV -->
  <header class="header">
    <div class="nav-left">
      <a href="../index.html" class="nav-link">Home</a>
      <a href="../averages/averages.html" class="nav-link">Rankings</a>
      <a href="../draft/draft.html" class="nav-link">Draft</a>
    </div>
    <div class="nav-right dropdown">
      <button class="dropbtn">Positions â–¾</button>
      <div class="dropdown-content">
        <a href="../positions/qbs.html">QBs</a>
        <a href="../positions/rbs.html">RBs</a>
        <a href="../positions/wrs.html">WRs</a>
        <a href="../positions/tes.html">TEs</a>
      </div>
    </div>
  </header>

  <main class="main-container">
    <!-- Player List Panel -->
    <section class="player-list">
      <h1>Player List</h1>
      <ul id="players"></ul>
    </section>

    <!-- Tier Columns Panel -->
    <section id="tier-container" class="tier-container">
      <!-- Tier columns will be injected by JS -->
    </section>
  </main>

  <!-- Action Buttons -->
  <div id="button-container">
    <button id="saveBtn" class="btn save-btn">Save</button>
    <button id="clearBtn" class="btn clear-btn">Clear</button>
  </div>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <!-- JS -->
  <script type="module">
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const db = window.db;
    const playersList = document.getElementById("players");
    const tierContainer = document.getElementById("tier-container");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const toast = document.getElementById("toast");

    const NUM_TIERS = 10;

    // Create Tier Columns dynamically
    function createTiers() {
      for (let i = 1; i <= NUM_TIERS; i++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-column";
        tierDiv.dataset.tier = i;
        tierDiv.innerHTML = `<h2>Tier ${i}</h2><ul class="dropzone" aria-label="Tier ${i} dropzone"></ul>`;

        const dropzone = tierDiv.querySelector(".dropzone");

        dropzone.addEventListener("dragover", e => e.preventDefault());
        dropzone.addEventListener("drop", e => {
          e.preventDefault();
          const id = e.dataTransfer.getData("text/plain");
          const draggedEl = document.getElementById(id);
          if (draggedEl && dropzone !== draggedEl.parentElement) {
            dropzone.appendChild(draggedEl);
          }
        });

        tierContainer.appendChild(tierDiv);
      }
    }

    // Load players from tiers.json (local file)
    async function loadPlayers() {
      try {
        const res = await fetch("tiers.json");
        const data = await res.json();

        data.forEach(player => {
          const li = document.createElement("li");
          li.textContent = `${player.name} (${player.position}, ADP: ${player.adp})`;
          li.id = `player-${player.id || player.name.replace(/\s+/g, "-").toLowerCase()}`;
          li.className = "player-item";
          li.draggable = true;

          li.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", li.id);
          });

          playersList.appendChild(li);
        });
      } catch (err) {
        showToast("Error loading players: " + err.message);
      }
    }

    // Save tiers to Firestore
    async function saveTiers() {
      const result = {};
      const tiers = document.querySelectorAll(".tier-column");

      tiers.forEach(tier => {
        const tierNum = tier.dataset.tier;
        const players = Array.from(tier.querySelectorAll(".dropzone > li"))
          .map(li => li.textContent);
        result[`Tier_${tierNum}`] = players;
      });

      try {
        await setDoc(doc(db, "tiers", "user1"), result);
        showToast("Tiers saved!");
      } catch (err) {
        showToast("Error saving tiers: " + err.message);
      }
    }

    // Load saved tiers from Firestore
    async function loadSavedTiers() {
      try {
        const docSnap = await getDoc(doc(db, "tiers", "user1"));
        if (docSnap.exists()) {
          const savedData = docSnap.data();

          for (const [tierKey, playerList] of Object.entries(savedData)) {
            const tierNum = tierKey.split("_")[1];
            const dropzone = document.querySelector(`.tier-column[data-tier='${tierNum}'] .dropzone`);

            playerList.forEach(text => {
              const allPlayers = document.querySelectorAll("#players li, .tier-column .dropzone > li");
              const match = Array.from(allPlayers).find(li => li.textContent === text);
              if (match) dropzone.appendChild(match);
            });
          }
        }
      } catch (err) {
        showToast("Error loading saved tiers: " + err.message);
      }
    }

    // Clear tiers and return all players to player list
    async function clearTiers() {
      const tierPlayers = document.querySelectorAll(".tier-column .dropzone > li");
      tierPlayers.forEach(player => {
        playersList.appendChild(player);
      });

      try {
        await setDoc(doc(db, "tiers", "user1"), {});
        showToast("Tiers cleared!");
      } catch (err) {
        showToast("Error clearing tiers: " + err.message);
      }
    }

    // Show toast notification
    function showToast(message) {
      toast.textContent = message;
      toast.style.visibility = "visible";
      toast.style.opacity = "1";

      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.visibility = "hidden";
      }, 3000);
    }

    // Initialize app
    (async () => {
      createTiers();
      await loadPlayers();
      await loadSavedTiers();
      saveBtn.addEventListener("click", saveTiers);
      clearBtn.addEventListener("click", clearTiers);
    })();
  </script>
</body>
</html>
